#Setup and configuration using Powershell for the Azure Automation Exercise


#Create and configure the Virtual Network and subnet
$rgName = "rosalio-onboarding"
$location = "East US"
$vnetName = "foxhouse"
$subnetName = "foxsub01"
$subnetConfig = New-AzVirtualNetworkSubnetConfig -Name $subnetName -AddressPrefix "<subnetAddressPrefix>"
$vnet = New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $rgName -Location $location -AddressPrefix "<vnetAddressPrefix>" -Subnet $subnetConfig


#Deploy a windows server vm as the Domain Controller 
$vmName = "foxvm01"
$pip = New-AzPublicIpAddress -Name "$vmName-pip" -ResourceGroupName $rgName -Location $location -AllocationMethod Dynamic
$nic = New-AzNetworkInterface -Name "$vmName-nic" -ResourceGroupName $rgName -Location $location -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id
$vmConfig = New-AzVMConfig -VMName $vmName -VMSize "Standard_DS2_v2"
$vm = Set-AzVMOperatingSystem -VM $vmConfig -Windows -ComputerName $vmName -Credential (Get-Credential) -ProvisionVMAgent -EnableAutoUpdate
$vm = Set-AzVMSourceImage -VM $vm -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer" -Skus "2019-Datacenter" -Version "latest"
$vm = Add-AzVMNetworkInterface -VM $vm -Id $nic.Id
$vm = Set-AzVMOSDisk -VM $vm -CreateOption FromImage -DiskSizeInGB 64
New-AzVM -ResourceGroupName $rgName -Location $location -VM $vm

#Configure Active Directory Domain Services on the VM


# Script to deploy  Django App VM & Variables for Django App VM
$djangoVmName = "foxweb01"
$djangoPip = New-AzPublicIpAddress -Name "$djangoVmName-pip" -ResourceGroupName $rgName -Location $location -AllocationMethod Dynamic
$djangoNic = New-AzNetworkInterface -Name "$djangoVmName-nic" -ResourceGroupName $rgName -Location $location -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $djangoPip.Id
$djangoVmConfig = New-AzVMConfig -VMName $djangoVmName -VMSize "Standard_DS2_v2"
$adminUsername = "fox"
$adminPassword = ConvertTo-SecureString 'fox' -AsPlainText -Force

# Set the operating system and image for the Django VM
$djangoVmConfig = Set-AzVMOperatingSystem -VM $djangoVmConfig -Linux -ComputerName $djangoVmName -Credential (New-Object System.Management.Automation.PSCredential ($adminUsername, $adminPassword))
$djangoVmConfig = Set-AzVMSourceImage -VM $djangoVmConfig -PublisherName "Canonical" -Offer "UbuntuServer" -Skus "18.04-LTS" -Version "latest"

# Add network interface
$djangoVmConfig = Add-AzVMNetworkInterface -VM $djangoVmConfig -Id $djangoNic.Id

# Set the OS disk
$djangoVmConfig = Set-AzVMOSDisk -VM $djangoVmConfig -CreateOption FromImage -DiskSizeInGB 64 -Caching "ReadWrite"

# Create the VM
New-AzVM -ResourceGroupName $rgName -Location $location -VM $djangoVmConfig





